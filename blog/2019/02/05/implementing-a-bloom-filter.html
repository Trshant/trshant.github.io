<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=0.5">
  <title>Implementing A Bloom Filter</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<style>
  body {
    margin: auto 0;
  }

  .button {
    border-radius: 2em !important;
  }
  @media (min-width: 768px) {
    .container {
      margin: 0 auto;
      width: 800px;
      font-size: 16px;
      line-height: 130%;
    }  
  }
  
  .header {
    width:100%;
    background-color: black;
    padding: 15px 5px;
    color: white;
  }
  div.sourceCode {
    padding-left: 4px;
    border-left: 2px solid black;
  }
  ul.nav {
    display: inline-flex;
    list-style-type: none;
  }
  ul.nav li {
    margin-left: 12px;  
  }
  ul.nav li a {
    text-decoration: none;
    color: white;
  }
  code {
    font-size: 14px;
    font-weight: 600;
  }
  </style>
</head>
<body>
<div class="header">
  Trshant's Rambling
  <ul class="nav" >
    <li><a href="/archive.html">Archives</a></li>
    <li><a href="/resume.pdf">Resume</a></li>
    <li><a href="/recipes.html">Recipes</a></li>
  </ul>
</div>

<div class="container">
<header>
<h1 class="title">Implementing A Bloom Filter</h1>

  <a class="button button-small" href="javascript: void(0)">Algorithm</a>
  <a class="button button-small" href="javascript: void(0)">blog</a>
  <a class="button button-small" href="javascript: void(0)">BloomFilter</a>


</header>
<p>A bloom filter is a data structure which allows the server to sync data with a client with low data consumption. Another usecase is to find the uniqueness of the data. <a href="https://www.geeksforgeeks.org/bloom-filters-introduction-and-python-implementation/">Geekforgeeks</a> has a pretty good explanation of bloom filters.</p>
<p>This post addresses the syncing the data from the server to client. We assume that the data on the client is already updating the server as and when the data is entered. The problem statement is not the unavailability or low availability of internet. Rather, it is to minimise the syncing operation involved.</p>
<p>The master hash is the ANDed product of all the individual hashes. The hashing function used here is the murmur hash which has great speed improvements over the normally used SHA256. We shall use Node.js for our proof of concept.</p>
<p><strong>Writing a small proof of concept with existing libraries</strong></p>
<p>From <a href="https://www.npmjs.com/package/murmurhash-native">Murmurhash-native</a>'s npm page</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span>  murmurHash  <span class="op">=</span>  <span class="at">require</span>(<span class="st">&#39;murmurhash-native&#39;</span>).<span class="at">murmurHash</span>
<span class="at">murmurHash</span>( <span class="st">&#39;hash me!&#39;</span> ) <span class="co">// 2061152078</span></code></pre></div>
<p>Now, using the same package, Lets hash a few strings:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span>  murmurHash  <span class="op">=</span>  <span class="at">require</span>(<span class="st">&#39;murmurhash-native&#39;</span>).<span class="at">murmurHash</span>

<span class="kw">var</span>  hash  <span class="op">=</span>  <span class="at">murmurHash</span>( <span class="st">&#39;hash me!&#39;</span> ) <span class="co">// 2061152078</span>
<span class="va">console</span>.<span class="at">log</span>( hash )<span class="op">;</span>

<span class="kw">var</span>  hash2  <span class="op">=</span>  <span class="at">murmurHash</span>(<span class="st">&#39;do me too&#39;</span>) <span class="co">// 3728646459</span>
<span class="va">console</span>.<span class="at">log</span>(hash2)<span class="op">;</span></code></pre></div>
<p>Now we need to OR it since we need all the bits set from all the hashes. ORing it all together, we get:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span>  oredhash  <span class="op">=</span>  hash  <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span>  <span class="op">|</span>  hash2  <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span> <span class="op">;</span>
oredhash  <span class="op">=</span>  oredhash  <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span><span class="op">;</span>
<span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot; Final hash : &quot;</span><span class="op">,</span>oredhash)<span class="op">;</span> <span class="co">// 4278103935</span></code></pre></div>
<p>This is our Masterhash. The 10-digit long string holds as many strings as we can give it.</p>
<p>Now we create a few more hashes to check against the master hash. we will create hashes for 2 strings, one of which is known to us and calculated in the masterhash. the other one will be an unfamiliar one.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span>  testHash1  <span class="op">=</span>  <span class="at">murmurHash</span>(<span class="st">&#39;not me!&#39;</span>) <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span>
<span class="va">console</span>.<span class="at">log</span>(testHash1)<span class="op">;</span> <span class="co">//1542629515</span>

<span class="co">// The Familiar one </span>
<span class="kw">var</span>  testHash2  <span class="op">=</span>  <span class="at">murmurHash</span>(<span class="st">&#39;do me too&#39;</span>) <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span>
<span class="va">console</span>.<span class="at">log</span>(testHash2)<span class="op">;</span> <span class="co">// 3728646459</span></code></pre></div>
<p>Now we need to check if the bits are set both in the individual hash as well as the master hash. Coding it up..... <code>javascript function  checkTheHashes( masterHash , hashToCheck ){     var  check  = (masterHash  &amp;  hashToCheck) &gt;&gt;&gt;  0;     //console.log(masterHash, hashToCheck, check);     if (check  ==  hashToCheck) {         return  true;     } else {         return  false;     } }</code></p>
<p>Lets run the function against the 2 hashes we created for checking against :</p>
<p>The <code>testHash1</code> should give a false since the data is not present in the masterhash:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">check  <span class="op">=</span>  <span class="at">checkTheHashes</span>(oredhash<span class="op">,</span> testHash1)<span class="op">;</span>
<span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot; checking hash </span><span class="sc">\&quot;</span><span class="st">not me!</span><span class="sc">\&quot;</span><span class="st"> (should be false) : &quot;</span><span class="op">,</span>check)<span class="op">;</span> <span class="co">// false</span></code></pre></div>
<p>The <code>testHash2</code> should give a true since the data is not present in the masterhash:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript">check  <span class="op">=</span>  <span class="at">checkTheHashes</span>(oredhash<span class="op">,</span> testHash2)<span class="op">;</span>
<span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot; checking hash </span><span class="sc">\&quot;</span><span class="st">do me too</span><span class="sc">\&quot;</span><span class="st"> (should be true): &quot;</span><span class="op">,</span>check)<span class="op">;</span> <span class="co">// true</span></code></pre></div>
<p>Now since i know it works, let me do the responsible thing and put it all in a class, so I dont pollute the global namespace.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> bloomFilter <span class="op">=</span> <span class="op">{</span>
    <span class="dt">masterHash </span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span>
    <span class="dt">hashDataPoint </span><span class="op">:</span> <span class="kw">function</span>( dataString )<span class="op">{</span>
        hash <span class="op">=</span> <span class="at">murmurHash</span>( dataString ) <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span>
        <span class="cf">if</span>( <span class="op">!</span><span class="at">isNull</span>( masterHash )  )<span class="op">{</span>
            <span class="kw">this</span><span class="op">,</span>masterHash <span class="op">=</span> <span class="kw">this</span>.<span class="at">masterHash</span> <span class="op">|</span> hash <span class="op">;</span>
        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
            <span class="kw">this</span>.<span class="at">masterHash</span> <span class="op">=</span> hash<span class="op">;</span>
        <span class="op">}</span>
    <span class="op">},</span>
    <span class="dt">checkIfPresent </span><span class="op">:</span> <span class="kw">function</span>( StringToCheck )<span class="op">{</span>
        hashToCheck <span class="op">=</span> <span class="kw">this</span>.<span class="at">hashDataPoint</span>(StringToCheck)<span class="op">;</span>
        <span class="kw">var</span>  check  <span class="op">=</span> ( <span class="kw">this</span>.<span class="at">masterHash</span>  <span class="op">&amp;</span>  hashToCheck) <span class="op">&gt;&gt;&gt;</span>  <span class="dv">0</span><span class="op">;</span>
        <span class="cf">if</span> (check  <span class="op">==</span>  hashToCheck) <span class="op">{</span>
            <span class="cf">return</span>  <span class="kw">true</span><span class="op">;</span>
        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span>
            <span class="cf">return</span>  <span class="kw">false</span><span class="op">;</span>
        <span class="op">}</span>
    <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>I am going to use this class later.</p>
<p>As we can see, it is quite useful for 1. checking uniqueness : where the answer for the <code>checkIfPresent</code> function is expected to be false. 2. availability of the data: where the answer for the <code>checkIfPresent</code> function is expected to be true.</p>
<p>More than that, we can see how much time and data it has saved us.</p>
<p>As we are concerned with syncing data between the server and client.</p>
<p>Here is how the interaction between the client/server will take place:</p>
<div>
<!-- htmlmin:ignore -->
<div class="mermaid">
sequenceDiagram
Client -&gt;&gt; Server: Hi! here's my master hash (CMH) with the last time synced

Note over Server,Client: 1. Check each data point against &lt;br/&gt;individual hashes.&lt;br/&gt;2. Collect all the ones where the bits&lt;br/&gt; dont match.&lt;br/&gt;3. Send the Collected data points &lt;br/&gt;back to the client with its own&lt;br/&gt; master hash (SMH).

Server -&gt;&gt; Client: There you go....
Client -&gt;&gt; Client : Updates Itself
</div>
<!-- htmlmin:ignore -->
</div>
<p>However, the server itself consists of 2 parts. the web server and the database server. The strategy for the maintaining the masterhash could be: 1. Update the hash probably in a field in the same table. or a linked one. 2. Continuously update the master hash with each insert or update. 3. Periodically refresh the masterhash ( use a Cron! ) to ensure the deleted data also is reflected in the masterhash.</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">SELECT</span> * <span class="kw">FROM</span> table_name <span class="kw">HAVING</span> hash_field_value &amp; CMH &lt;&gt; hash_field_value</code></pre></div>
<p>The above SQL will return only those rows from the tablename which 1. Are not present in the client system 2. Updated rows in the server which have yet been synced with the client system.</p>
<p>The syncing happens recursively till both the systems have the same Masterhash. I will be elaborating on that in a future post.</p>
<hr />
<p>Some reading: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators" class="uri">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators</a></p>
<blockquote>
<p>Written with <a href="https://stackedit.io/">StackEdit</a>. <!--stackedit_data:
eyJoaXN0b3J5IjpbLTc0MDY4NDgxOCwtMTMzMzQ4MTY3LC0yMD
MwMTYwMDc0LDIxMTY1NzUwMjAsMTkwODQ0NzYzNF19
--></p>
</blockquote>
<link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css">
<script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
</div>
</body>
</html>
