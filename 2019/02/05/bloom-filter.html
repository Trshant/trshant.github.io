<p>A bloom filter is a data structure which allows the server to sync data with a client with low data consumption. Another usecase is to find out uniqueness of the data. <a href="https://www.geeksforgeeks.org/bloom-filters-introduction-and-python-implementation/">Geekforgeeks</a> have a pretty good explanation of bloom filters.</p>

<p>My post is for syncing the data from the server to client. I am assuming that the data on the client is already updating the server as and when the data is entered. The problem statement is not the unavailability or low availability of internet. It is to minimise the syncing operation involved.</p>

<p>The master hash is the ANDed product of all the individual hashes. The hashing function used here is the murmur hash which has great speed improvements over the normally used  SHA256. In NodeJS, this is how we use it.</p>

<p><strong>Writing a small proof of concept with existing libraries</strong></p>

<p>From <a href="https://www.npmjs.com/package/murmurhash-native">Murmurhash-native</a>’s npm page</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span>  <span class="nx">murmurHash</span>  <span class="o">=</span>  <span class="nx">require</span><span class="p">(</span><span class="s1">'murmurhash-native'</span><span class="p">).</span><span class="nx">murmurHash</span>
<span class="nx">murmurHash</span><span class="p">(</span> <span class="s1">'hash me!'</span> <span class="p">)</span> <span class="c1">// 2061152078</span>
</code></pre></div></div>

<p>Now, using the same package, Lets hash a few strings:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span>  <span class="nx">murmurHash</span>  <span class="o">=</span>  <span class="nx">require</span><span class="p">(</span><span class="s1">'murmurhash-native'</span><span class="p">).</span><span class="nx">murmurHash</span>

<span class="kd">var</span>  <span class="nx">hash</span>  <span class="o">=</span>  <span class="nx">murmurHash</span><span class="p">(</span> <span class="s1">'hash me!'</span> <span class="p">)</span> <span class="c1">// 2061152078</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">hash</span> <span class="p">);</span>

<span class="kd">var</span>  <span class="nx">hash2</span>  <span class="o">=</span>  <span class="nx">murmurHash</span><span class="p">(</span><span class="s1">'do me too'</span><span class="p">)</span> <span class="c1">// 3728646459</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hash2</span><span class="p">);</span>
</code></pre></div></div>
<p>Now we need to OR it since we need all the bits set from all the hashes. ORing it all together, we get:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span>  <span class="nx">oredhash</span>  <span class="o">=</span>  <span class="nx">hash</span>  <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span>  <span class="o">|</span>  <span class="nx">hash2</span>  <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span> <span class="p">;</span>
<span class="nx">oredhash</span>  <span class="o">=</span>  <span class="nx">oredhash</span>  <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" Final hash : "</span><span class="p">,</span><span class="nx">oredhash</span><span class="p">);</span> <span class="c1">// 4278103935</span>
</code></pre></div></div>
<p>Hence now we have the masterhash.</p>

<p>Now we need to create a few more hashes to check against the master hash.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span>  <span class="nx">hash3</span>  <span class="o">=</span>  <span class="nx">murmurHash</span><span class="p">(</span><span class="s1">'not me!'</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hash3</span><span class="p">);</span> <span class="c1">//1542629515</span>

<span class="kd">var</span>  <span class="nx">hash4</span>  <span class="o">=</span>  <span class="nx">murmurHash</span><span class="p">(</span><span class="s1">'do me too'</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hash4</span><span class="p">);</span> <span class="c1">// 3728646459</span>
</code></pre></div></div>

<p>Now we need to check if the bits are set both in the individual hash as well as the master hash.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span>  <span class="nx">checkTheHashes</span><span class="p">(</span> <span class="nx">masterHash</span> <span class="p">,</span> <span class="nx">hashToCheck</span> <span class="p">){</span>
	<span class="kd">var</span>  <span class="nx">check</span>  <span class="o">=</span> <span class="p">(</span><span class="nx">masterHash</span>  <span class="o">&amp;</span>  <span class="nx">hashToCheck</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="c1">//console.log(masterHash, hashToCheck, check);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">check</span>  <span class="o">==</span>  <span class="nx">hashToCheck</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>  <span class="kc">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span>  <span class="kc">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>checking the hashes…</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">check</span>  <span class="o">=</span>  <span class="nx">checkTheHashes</span><span class="p">(</span><span class="nx">oredhash</span><span class="p">,</span> <span class="nx">hash3</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" checking hash </span><span class="se">\"</span><span class="s2">not me!</span><span class="se">\"</span><span class="s2"> (should be false) : "</span><span class="p">,</span><span class="nx">check</span><span class="p">);</span> <span class="c1">// false</span>
<span class="nx">check</span>  <span class="o">=</span>  <span class="nx">checkTheHashes</span><span class="p">(</span><span class="nx">oredhash</span><span class="p">,</span> <span class="nx">hash4</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">" checking hash </span><span class="se">\"</span><span class="s2">do me too</span><span class="se">\"</span><span class="s2"> (should be true): "</span><span class="p">,</span><span class="nx">check</span><span class="p">);</span> <span class="c1">// true</span>
</code></pre></div></div>
<p>Now since i know it works, let me put it all in a class, so I dont pollute the global namespace.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">bloomFilter</span> <span class="o">=</span> <span class="p">{</span>
	<span class="na">masterHash</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
	<span class="na">hashDataPoint</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">dataString</span> <span class="p">){</span>
		<span class="nx">hash</span> <span class="o">=</span> <span class="nx">murmurHash</span><span class="p">(</span> <span class="nx">dataString</span> <span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">isNull</span><span class="p">(</span> <span class="nx">masterHash</span> <span class="p">)</span>  <span class="p">){</span>
			<span class="k">this</span><span class="p">,</span><span class="nx">masterHash</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">masterHash</span> <span class="o">|</span> <span class="nx">hash</span> <span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">masterHash</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="na">checkIfPresent</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">StringToCheck</span> <span class="p">){</span>
	    <span class="nx">hashToCheck</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hashDataPoint</span><span class="p">(</span><span class="nx">StringToCheck</span><span class="p">);</span>
		<span class="kd">var</span>  <span class="nx">check</span>  <span class="o">=</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">masterHash</span>  <span class="o">&amp;</span>  <span class="nx">hashToCheck</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">check</span>  <span class="o">==</span>  <span class="nx">hashToCheck</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span>  <span class="kc">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span>  <span class="kc">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>I am going to use this class later.</p>

<p>As we can see, it is quite useful for checking uniqueness and availability of the data, depending on the answer expected is positive or negative.</p>

<hr />
<p>As we are concerned with syncing data between the server and client.</p>

<p>Here is how the interaction between the client/server will take place:</p>
<pre><code class="language-mermaid">sequenceDiagram
Client -&gt;&gt; Server: Hi! here's my master hash (CMH) with the last time synced

Note over Server,Client: 1. Check each data point against &lt;br/&gt;individual hashes.&lt;br/&gt;2. Collect all the ones where the bits&lt;br/&gt; dont match.&lt;br/&gt;3. Send the Collected data points &lt;br/&gt;back to the client with its own&lt;br/&gt; master hash (SMH).

Server -&gt;&gt; Client: There you go....
Client -&gt;&gt; Client : Updates Itself
</code></pre>

<p>However, the server itself consists of 2 parts. the web server and the database server. In the code examples above we saw that we can use the murmurhash to update the hash probably in a field in the same table. Along with this, we need to continuously update the master hash with each insert or update, periodically refreshing the masterhash.</p>
<pre><code class="language-SQL">SELECT * FROM table_name HAVING hash_field_value &amp; CMH &lt;&gt; hash_field_value
</code></pre>
<p>The above SQL will return only those rows from the tablename which are not there or updated in the client system.</p>

<hr />

<p>Some reading:
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators</a></p>

<blockquote>
  <p>Written with <a href="https://stackedit.io/">StackEdit</a>.
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTkwODQ0NzYzNF19
--></p>
</blockquote>
